import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Loader2, Sparkles, Eye, EyeOff, CheckCircle, AlertCircle } from 'lucide-react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Textarea } from '@/components/ui/textarea';
import { IndustryAnalysisService, INDUSTRIES, type IndustryAnalysisResult } from '@/services/ai/industryAnalysisService';
import { UnifiedPromptService } from '@/services/content/unifiedPromptService';
import { toast } from 'sonner';

interface IndustrySelectorProps {
  selectedIndustry?: string;
  onIndustryChange: (industry: string) => void;
  businessContext?: string;
  clientName?: string;
  showPromptPreview?: boolean;
  required?: boolean;
}

const IndustrySelector: React.FC<IndustrySelectorProps> = ({
  selectedIndustry,
  onIndustryChange,
  businessContext = '',
  clientName = '',
  showPromptPreview = true,
  required = true
}) => {
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysisResult, setAnalysisResult] = useState<IndustryAnalysisResult | null>(null);
  const [showPreview, setShowPreview] = useState(false);
  const [promptPreview, setPromptPreview] = useState('');

  // Analyser automatiquement quand le contexte change
  useEffect(() => {
    if (businessContext.length > 20) {
      handleAutoAnalysis();
    }
  }, [businessContext]);

  // G√©n√©rer la pr√©visualisation du prompt quand le secteur change
  useEffect(() => {
    if (selectedIndustry && showPromptPreview) {
      generatePromptPreview();
    }
  }, [selectedIndustry, showPromptPreview]);

  const handleAutoAnalysis = async () => {
    if (!businessContext || businessContext.length < 20) {
      return;
    }

    setIsAnalyzing(true);
    try {
      const result = await IndustryAnalysisService.analyzeIndustry(
        businessContext,
        clientName
      );
      
      setAnalysisResult(result);
      
      if (result.confidence > 70) {
        toast.success(`Secteur "${INDUSTRIES.find(i => i.key === result.suggestedIndustry)?.label}" sugg√©r√© avec ${result.confidence}% de confiance`);
      }
    } catch (error) {
      console.error('Erreur analyse secteur:', error);
      toast.error('Erreur lors de l\'analyse automatique du secteur');
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleAcceptSuggestion = () => {
    if (analysisResult) {
      onIndustryChange(analysisResult.suggestedIndustry);
      toast.success('Secteur sugg√©r√© appliqu√© !');
    }
  };

  const generatePromptPreview = () => {
    if (!selectedIndustry) {
      setPromptPreview('');
      return;
    }

    try {
      // Cr√©er un exemple de prompt avec le secteur s√©lectionn√©
      const samplePrompt = UnifiedPromptService.buildUnifiedPrompt({
        clientContext: businessContext || 'Exemple d\'entreprise dans ce secteur',
        industry: selectedIndustry,
        targetPersona: 'clients potentiels',
        campaignContext: 'Campagne exemple',
        adGroupContext: 'Groupe exemple',
        keywords: ['mot-cl√©', 'exemple'],
        model: 'claude-sonnet-4-20250514'
      });

      setPromptPreview(samplePrompt);
    } catch (error) {
      console.error('Erreur g√©n√©ration preview:', error);
    }
  };

  const getIndustryIcon = (industryKey: string) => {
    const icons: { [key: string]: string } = {
      'e-commerce': 'üõí',
      'services-professionnels': 'üîß',
      'technologie': 'üíª',
      'immobilier': 'üè°',
      'sante-bien-etre': '‚öïÔ∏è',
      'formation-education': 'üéì',
      'finance-assurance': 'üí∞',
      'tourisme-loisirs': '‚úàÔ∏è',
      'automobile': 'üöó',
      'restaurant-alimentation': 'üçΩÔ∏è',
      'mode-beaute': 'üëó',
      'construction-renovation': 'üî®',
      'sport-fitness': 'üí™',
      'juridique': '‚öñÔ∏è',
      'autre': 'üìã'
    };
    return icons[industryKey] || 'üìã';
  };

  const selectedIndustryDetails = selectedIndustry 
    ? INDUSTRIES.find(ind => ind.key === selectedIndustry)
    : null;

  return (
    <div className="space-y-4">
      {/* Section principale de s√©lection */}
      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-lg flex items-center gap-2">
            üéØ Secteur d'activit√©
            {required && <Badge variant="destructive" className="text-xs">Obligatoire</Badge>}
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          
          {/* Analyse automatique */}
          {businessContext.length > 20 && (
            <div className="space-y-3">
              <div className="flex items-center gap-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleAutoAnalysis}
                  disabled={isAnalyzing}
                  className="flex items-center gap-2"
                >
                  {isAnalyzing ? (
                    <Loader2 className="h-4 w-4 animate-spin" />
                  ) : (
                    <Sparkles className="h-4 w-4" />
                  )}
                  {isAnalyzing ? 'Analyse en cours...' : 'Analyser avec IA'}
                </Button>
                
                {showPromptPreview && (
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setShowPreview(!showPreview)}
                    className="flex items-center gap-2"
                  >
                    {showPreview ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                    {showPreview ? 'Masquer' : 'Voir impact'} prompt
                  </Button>
                )}
              </div>

              {/* R√©sultat de l'analyse */}
              {analysisResult && (
                <Alert className={analysisResult.confidence > 70 ? 'border-green-200 bg-green-50' : 'border-orange-200 bg-orange-50'}>
                  <div className="flex items-start gap-3">
                    {analysisResult.confidence > 70 ? (
                      <CheckCircle className="h-5 w-5 text-green-600 mt-0.5" />
                    ) : (
                      <AlertCircle className="h-5 w-5 text-orange-600 mt-0.5" />
                    )}
                    <div className="flex-1 space-y-2">
                      <div className="flex items-center gap-2">
                        <span className="font-medium">
                          Secteur sugg√©r√© : {INDUSTRIES.find(i => i.key === analysisResult.suggestedIndustry)?.label}
                        </span>
                        <Badge variant={analysisResult.confidence > 70 ? "default" : "secondary"}>
                          {analysisResult.confidence}% confiance
                        </Badge>
                      </div>
                      <p className="text-sm text-muted-foreground">
                        {analysisResult.reasoning}
                      </p>
                      {analysisResult.suggestedIndustry !== selectedIndustry && (
                        <Button
                          size="sm"
                          onClick={handleAcceptSuggestion}
                          className="mt-2"
                        >
                          Appliquer cette suggestion
                        </Button>
                      )}
                    </div>
                  </div>
                </Alert>
              )}
            </div>
          )}

          {/* S√©lecteur de secteur */}
          <div className="space-y-2">
            <Select value={selectedIndustry} onValueChange={onIndustryChange}>
              <SelectTrigger>
                <SelectValue placeholder="S√©lectionnez le secteur d'activit√© principal" />
              </SelectTrigger>
              <SelectContent>
                {INDUSTRIES.map(industry => (
                  <SelectItem key={industry.key} value={industry.key}>
                    <div className="flex items-center gap-2">
                      <span>{getIndustryIcon(industry.key)}</span>
                      <span>{industry.label}</span>
                    </div>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            
            {selectedIndustryDetails && (
              <div className="p-3 bg-muted rounded-md">
                <p className="text-sm text-muted-foreground">
                  {selectedIndustryDetails.description}
                </p>
                {selectedIndustryDetails.examples.length > 0 && (
                  <div className="mt-2">
                    <span className="text-xs font-medium">Exemples : </span>
                    <span className="text-xs text-muted-foreground">
                      {selectedIndustryDetails.examples.join(', ')}
                    </span>
                  </div>
                )}
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Pr√©visualisation de l'impact sur le prompt */}
      {showPreview && selectedIndustry && promptPreview && (
        <Card>
          <CardHeader>
            <CardTitle className="text-lg flex items-center gap-2">
              üëÅÔ∏è Impact du secteur sur le prompt de g√©n√©ration
            </CardTitle>
          </CardHeader>
          <CardContent>
            <Tabs defaultValue="section" className="space-y-4">
              <TabsList className="grid w-full grid-cols-2">
                <TabsTrigger value="section">Section sp√©cialis√©e</TabsTrigger>
                <TabsTrigger value="full">Prompt complet</TabsTrigger>
              </TabsList>
              
              <TabsContent value="section" className="space-y-4">
                <Alert>
                  <AlertCircle className="h-4 w-4" />
                  <AlertDescription>
                    Voici comment le secteur "{selectedIndustryDetails?.label}" influence les strat√©gies de g√©n√©ration :
                  </AlertDescription>
                </Alert>
                
                <div className="bg-muted p-4 rounded-md">
                  <pre className="text-sm whitespace-pre-wrap font-mono">
                    {promptPreview.split('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')[2]?.split('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')[0] || 'Section non trouv√©e'}
                  </pre>
                </div>
              </TabsContent>
              
              <TabsContent value="full" className="space-y-4">
                <Alert>
                  <AlertCircle className="h-4 w-4" />
                  <AlertDescription>
                    Prompt complet g√©n√©r√© avec le secteur s√©lectionn√© (aper√ßu pour transparence) :
                  </AlertDescription>
                </Alert>
                
                <Textarea
                  value={promptPreview}
                  readOnly
                  rows={15}
                  className="font-mono text-xs"
                />
              </TabsContent>
            </Tabs>
          </CardContent>
        </Card>
      )}
    </div>
  );
};

export default IndustrySelector;